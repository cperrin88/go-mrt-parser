package test

import (
	"bytes"
	"github.com/cperrin88/go-mrt-parser/pkg/mrt"
	"testing"
)

func TestPeerIndexTable(t *testing.T) {
	tableData := bytes.NewBuffer([]byte{
		0x00, 0x00, 0x12, 0x34, //Collector BGP ID: 0
		0x00, 0x04, //View Name Length
		0x54, 0x65, 0x73, 0x74, //View Name: 0
		0x00, 0x04, //Peer Count: 4
		//Peer0
		0x00,                   //Type: 0
		0x00, 0x00, 0x00, 0x00, //Peer BGP ID: 0
		0x00, 0x00, 0x00, 0x00, //Peer IP: 0.0.0.0
		0x00, 0x00, //Peer AS: 0
		//Peer1
		0x01,                   //Type: 1
		0x10, 0x00, 0x00, 0x00, //Peer BGP ID: 0
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //Peer IP: [1::]
		0x00, 0x01, //Peer AS: 1
		//Peer2
		0x02,                   //Type: 2
		0x20, 0x00, 0x00, 0x00, //Peer BGP ID: 0
		0x02, 0x00, 0x00, 0x00, //Peer IP: 2.0.0.0
		0x00, 0x00, 0x00, 0x02, //Peer AS: 2
		//Peer3
		0x03,                   //Type: 3
		0x30, 0x00, 0x00, 0x00, //Peer BGP ID: 0
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //Peer IP: [3::]
		0x00, 0x00, 0x00, 0x03, //Peer AS: 3
	})

	data := mrt.ParsePeerIndexTable(tableData)

	if len(data.PeerEntries) != 4 {
		t.Fatalf("Expected 4 peer entry got %d", len(data.PeerEntries))
	}

}
